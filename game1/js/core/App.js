"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var THREE = require("../../miniprogram_npm/three/index");
var PhysicsView_1 = require("./PhysicsView");
var Store_1 = require("./Store");
var Fire_1 = require("./Fire");
var OIMO = require('../../miniprogram_npm/oimo/index');
console.log("oimo");
console.log(OIMO);
var App = (function () {
    function App(canvas) {
        this.updaters = [];
        this.store = new Store_1.default();
        this.canvas = canvas;
        this.world = new OIMO.World({
            timestep: 1 / 60,
            iterations: 8,
            broadphase: 2,
            worldscale: 1,
            random: true,
            info: false,
            gravity: [0, -9.8, 0]
        });
        this.initGraphics();
        this.initPhysics();
        this.createObjects();
        this.animate();
    }
    App.prototype.initGraphics = function () {
        this.camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.2, 2000);
        this.scene = new THREE.Scene();
        this.camera.position.set(-25, 25, 78);
        this.camera.lookAt(new THREE.Vector3());
        console.log(this.camera);
        this.renderer = new THREE.WebGLRenderer({
            canvas: this.canvas,
            antialias: true,
            alpha: true
        });
        this.renderer.setClearColor(0x000000);
        this.renderer.setPixelRatio(window.devicePixelRatio);
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        this.renderer.shadowMap.enabled = true;
        this.fire = new Fire_1.default();
        this.scene.add(this.fire.light);
        window.addEventListener('resize', this.onResize, false);
    };
    App.prototype.onResize = function (e) {
        this.size = this.getStageSize(true);
        this.canvas.width = this.size.width;
        this.canvas.height = this.size.height;
        this.camera.aspect = this.size.width / this.size.height;
        this.camera.updateProjectionMatrix();
        this.renderer.setSize(this.size.width, this.size.height);
    };
    App.prototype.getStageSize = function (usePixel) {
        var size = { width: window.innerWidth };
        if (window.innerWidth > window.innerHeight) {
            size.height = window.innerHeight;
        }
        else {
            size.height = window.innerWidth;
        }
        if (usePixel) {
            size.width = size.width * window.devicePixelRatio;
            size.height = size.height * window.devicePixelRatio;
        }
        return size;
    };
    App.prototype.initPhysics = function () {
        this.addStaticBox([4, 40, 40], [-10, -4, 0], [0, 0, 0]);
        this.addStaticBox([4, 40, 40], [10, -4, 0], [0, 0, 0]);
        this.addStaticBox([80, 8, 80], [0, -2, 0], [30, 0, 0]);
    };
    App.prototype.addStaticBox = function (size, position, rotation) {
        this.world.add({ size: size, pos: position, rot: rotation, move: false });
        var ToRad = 0.0174532925199432957;
        var mat = new THREE.MeshStandardMaterial();
        mat.metalness = 0.1;
        mat.roughness = 0.72;
        mat.map = new THREE.TextureLoader().load("images/img/p6.jpg");
        var mesh = new THREE.Mesh(new THREE.BoxGeometry(), mat);
        mesh.scale.set(size[0], size[1], size[2]);
        mesh.position.set(position[0], position[1], position[2]);
        mesh.rotation.set(rotation[0] * ToRad, rotation[1] * ToRad, rotation[2] * ToRad);
        this.scene.add(mesh);
        mesh.castShadow = true;
        mesh.receiveShadow = true;
    };
    App.prototype.createObjects = function () {
        for (var i = 0; i < 1000; i++) {
            var type = "sphere";
            if (i % 2) {
                type = "box";
            }
            var shape = void 0;
            if (type == "box") {
                shape = this.store.getBoxBufferGeometry();
            }
            else {
                shape = this.store.getSphereBufferGeometry();
            }
            var view = new THREE.Mesh(shape, this.store.getMaterial());
            var x = (0.5 - Math.random()) * 40;
            var y = Math.random() * 1600;
            var z = (0.5 - Math.random()) * 40;
            view.position.set(x, y, z);
            view.castShadow = true;
            view.receiveShadow = true;
            this.scene.add(view);
            this.updaters.push(new PhysicsView_1.default(view, type, this.world));
        }
    };
    App.prototype.initInput = function () {
    };
    App.prototype.animate = function () {
        var _this = this;
        requestAnimationFrame(function () {
            _this.animate();
        });
        this.world.step();
        this.fire.update();
        this.updaters.forEach(function (item) {
            item.update();
        });
        this.render();
    };
    App.prototype.render = function () {
        this.renderer.render(this.scene, this.camera);
    };
    return App;
}());
exports.default = App;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXBwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiQXBwLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0EseURBQTBEO0FBRTFELDZDQUF3QztBQUN4QyxpQ0FBNEI7QUFDNUIsK0JBQTBCO0FBSTFCLElBQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxrQ0FBa0MsQ0FBQyxDQUFBO0FBRXhELE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDcEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUVsQjtJQWlCSSxhQUFZLE1BQVU7UUFKdEIsYUFBUSxHQUF1QixFQUFFLENBQUM7UUFDbEMsVUFBSyxHQUFTLElBQUksZUFBSyxFQUFFLENBQUM7UUFJdEIsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDckIsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUM7WUFDeEIsUUFBUSxFQUFFLENBQUMsR0FBRyxFQUFFO1lBQ2hCLFVBQVUsRUFBRSxDQUFDO1lBQ2IsVUFBVSxFQUFFLENBQUM7WUFDYixVQUFVLEVBQUUsQ0FBQztZQUNiLE1BQU0sRUFBRSxJQUFJO1lBQ1osSUFBSSxFQUFFLEtBQUs7WUFDWCxPQUFPLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1NBQ3hCLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUNwQixJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDbkIsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUNuQixDQUFDO0lBRUQsMEJBQVksR0FBWjtRQUNJLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxLQUFLLENBQUMsaUJBQWlCLENBQUUsRUFBRSxFQUFFLE1BQU0sQ0FBQyxVQUFVLEdBQUcsTUFBTSxDQUFDLFdBQVcsRUFBRSxHQUFHLEVBQUUsSUFBSSxDQUFFLENBQUM7UUFFbkcsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUMvQixJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ3RDLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7UUFDeEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7UUFNekIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLEtBQUssQ0FBQyxhQUFhLENBQUM7WUFDcEMsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNO1lBQ25CLFNBQVMsRUFBRSxJQUFJO1lBQ2YsS0FBSyxFQUFFLElBQUk7U0FDZCxDQUFDLENBQUM7UUFDSCxJQUFJLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBRSxRQUFRLENBQUUsQ0FBQztRQUN4QyxJQUFJLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBRSxNQUFNLENBQUMsZ0JBQWdCLENBQUUsQ0FBQztRQUN2RCxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBRSxNQUFNLENBQUMsVUFBVSxFQUFFLE1BQU0sQ0FBQyxXQUFXLENBQUUsQ0FBQztRQUMvRCxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDO1FBS3ZDLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxjQUFJLEVBQUUsQ0FBQztRQUN2QixJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBRSxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBRSxDQUFDO1FBRWxDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBRSxRQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUUsQ0FBQztJQUM5RCxDQUFDO0lBRUQsc0JBQVEsR0FBUixVQUFTLENBQU87UUFDWixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDcEMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDcEMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUM7UUFDdEMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUM7UUFDeEQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO1FBQ3JDLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDN0QsQ0FBQztJQUVELDBCQUFZLEdBQVosVUFBYSxRQUFpQjtRQUMxQixJQUFJLElBQUksR0FBTyxFQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsVUFBVSxFQUFDLENBQUM7UUFDMUMsSUFBRyxNQUFNLENBQUMsVUFBVSxHQUFHLE1BQU0sQ0FBQyxXQUFXLEVBQUM7WUFDdEMsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUMsV0FBVyxDQUFDO1NBQ3BDO2FBQ0c7WUFDQSxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUM7U0FDbkM7UUFDRCxJQUFHLFFBQVEsRUFBQztZQUNSLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssR0FBRyxNQUFNLENBQUMsZ0JBQWdCLENBQUM7WUFDbEQsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQztTQUN2RDtRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFRCx5QkFBVyxHQUFYO1FBQ0ksSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN4RCxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN2RCxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQVkzRCxDQUFDO0lBRUQsMEJBQVksR0FBWixVQUFhLElBQVEsRUFBRSxRQUFZLEVBQUUsUUFBWTtRQUM3QyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxHQUFHLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUMsQ0FBQyxDQUFDO1FBRXhFLElBQUssS0FBSyxHQUFHLHFCQUFxQixDQUFDO1FBQ25DLElBQUksR0FBRyxHQUErQixJQUFJLEtBQUssQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1FBQ3ZFLEdBQUcsQ0FBQyxTQUFTLEdBQUcsR0FBRyxDQUFDO1FBQ3BCLEdBQUcsQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDO1FBQ3JCLEdBQUcsQ0FBQyxHQUFHLEdBQUcsSUFBSSxLQUFLLENBQUMsYUFBYSxFQUFFLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLENBQUM7UUFDOUQsSUFBSSxJQUFJLEdBQUcsSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFFLElBQUksS0FBSyxDQUFDLFdBQVcsRUFBRSxFQUFFLEdBQUcsQ0FBRSxDQUFDO1FBQzFELElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFFLENBQUM7UUFDNUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUUsQ0FBQztRQUMzRCxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBRSxRQUFRLENBQUMsQ0FBQyxDQUFDLEdBQUcsS0FBSyxFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUMsR0FBRyxLQUFLLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBRSxDQUFDO1FBQ25GLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFFLElBQUksQ0FBRSxDQUFDO1FBRXZCLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDO0lBQzlCLENBQUM7SUFFRCwyQkFBYSxHQUFiO1FBQ0ksS0FBSSxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksRUFBRSxDQUFDLEVBQUUsRUFBQztZQUN6QixJQUFJLElBQUksR0FBRyxRQUFRLENBQUM7WUFDcEIsSUFBRyxDQUFDLEdBQUcsQ0FBQyxFQUFDO2dCQUNMLElBQUksR0FBRSxLQUFLLENBQUM7YUFDZjtZQUNELElBQUksS0FBSyxTQUFBLENBQUM7WUFDVixJQUFHLElBQUksSUFBSSxLQUFLLEVBQUM7Z0JBQ2IsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsb0JBQW9CLEVBQUUsQ0FBQzthQUM3QztpQkFDRztnQkFDQSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyx1QkFBdUIsRUFBRSxDQUFDO2FBQ2hEO1lBQ0QsSUFBSSxJQUFJLEdBQUcsSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7WUFDM0QsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQ25DLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUM7WUFDN0IsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQ25DLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDM0IsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUM7WUFDdkIsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUM7WUFDMUIsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDckIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxxQkFBVyxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7U0FDL0Q7SUFFTCxDQUFDO0lBRUQsdUJBQVMsR0FBVDtJQUVBLENBQUM7SUFFRCxxQkFBTyxHQUFQO1FBQUEsaUJBV0M7UUFWRyxxQkFBcUIsQ0FBQztZQUNsQixLQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDbkIsQ0FBQyxDQUFDLENBQUM7UUFDSCxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ2xCLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDbkIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsVUFBQyxJQUFnQjtZQUNuQyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDbEIsQ0FBQyxDQUFDLENBQUE7UUFDRixJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7SUFFbEIsQ0FBQztJQUVELG9CQUFNLEdBQU47UUFLSSxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBRSxJQUFJLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUUsQ0FBQztJQUVwRCxDQUFDO0lBRUwsVUFBQztBQUFELENBQUMsQUFqTEQsSUFpTEMiLCJzb3VyY2VzQ29udGVudCI6WyJcclxuaW1wb3J0ICogYXMgVEhSRUUgZnJvbSAnLi4vLi4vbWluaXByb2dyYW1fbnBtL3RocmVlL2luZGV4J1xyXG4vLyBpbXBvcnQgeyBPcmJpdENvbnRyb2xzIH0gZnJvbSAnLi4vLi4vbWluaXByb2dyYW1fbnBtL3RocmVlL2V4YW1wbGVzL2pzbS9jb250cm9scy9PcmJpdENvbnRyb2xzJztcclxuaW1wb3J0IFBoeXNpY3NWaWV3IGZyb20gJy4vUGh5c2ljc1ZpZXcnO1xyXG5pbXBvcnQgU3RvcmUgZnJvbSAnLi9TdG9yZSc7XHJcbmltcG9ydCBGaXJlIGZyb20gJy4vRmlyZSc7XHJcbi8vIGltcG9ydCBDb21wdXRlR2VvbWV0cnkgZnJvbSAnLi9Db21wdXRlR2VvbWV0cnknO1xyXG5cclxuLy8gaW1wb3J0ICogYXMgQW1tbyBmcm9tICcuLi9hc3NldC9saWIvYW1tbydcclxuY29uc3QgT0lNTyA9IHJlcXVpcmUoJy4uLy4uL21pbmlwcm9ncmFtX25wbS9vaW1vL2luZGV4JylcclxuXHJcbmNvbnNvbGUubG9nKFwib2ltb1wiKTtcclxuY29uc29sZS5sb2coT0lNTyk7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBBcHB7XHJcblxyXG4gICAgLy8gY29udHJvbHM6T3JiaXRDb250cm9scztcclxuICAgIGNhbWVyYTogVEhSRUUuUGVyc3BlY3RpdmVDYW1lcmE7XHJcbiAgICBzY2VuZTogVEhSRUUuU2NlbmU7XHJcbiAgICByZW5kZXJlcjogVEhSRUUuV2ViR0xSZW5kZXJlcjtcclxuICAgIHNpemU6YW55O1xyXG4gICAgY2FudmFzOiBhbnk7XHJcbiAgICBzdGF0czogYW55O1xyXG4gICAgY2xvY2s6IFRIUkVFLkNsb2NrO1xyXG5cclxuICAgIHBoeXNpY3NXb3JsZDphbnk7XHJcbiAgICB3b3JsZDphbnk7XHJcbiAgICB1cGRhdGVyczogQXJyYXk8UGh5c2ljc1ZpZXc+ID0gW107XHJcbiAgICBzdG9yZTpTdG9yZSA9IG5ldyBTdG9yZSgpO1xyXG4gICAgZmlyZTpGaXJlO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKGNhbnZhczphbnkpe1xyXG4gICAgICAgIHRoaXMuY2FudmFzID0gY2FudmFzO1xyXG4gICAgICAgIHRoaXMud29ybGQgPSBuZXcgT0lNTy5Xb3JsZCh7IFxyXG4gICAgICAgICAgICB0aW1lc3RlcDogMSAvIDYwLCBcclxuICAgICAgICAgICAgaXRlcmF0aW9uczogOCwgXHJcbiAgICAgICAgICAgIGJyb2FkcGhhc2U6IDIsIC8vIDEgYnJ1dGUgZm9yY2UsIDIgc3dlZXAgYW5kIHBydW5lLCAzIHZvbHVtZSB0cmVlXHJcbiAgICAgICAgICAgIHdvcmxkc2NhbGU6IDEsIC8vIHNjYWxlIGZ1bGwgd29ybGQgXHJcbiAgICAgICAgICAgIHJhbmRvbTogdHJ1ZSwgIC8vIHJhbmRvbWl6ZSBzYW1wbGVcclxuICAgICAgICAgICAgaW5mbzogZmFsc2UsICAgLy8gY2FsY3VsYXRlIHN0YXRpc3RpYyBvciBub3RcclxuICAgICAgICAgICAgZ3Jhdml0eTogWzAsIC05LjgsIDBdIFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB0aGlzLmluaXRHcmFwaGljcygpO1xyXG4gICAgICAgIHRoaXMuaW5pdFBoeXNpY3MoKTtcclxuICAgICAgICB0aGlzLmNyZWF0ZU9iamVjdHMoKTtcclxuICAgICAgICB0aGlzLmFuaW1hdGUoKTtcclxuICAgIH1cclxuXHJcbiAgICBpbml0R3JhcGhpY3MoKXtcclxuICAgICAgICB0aGlzLmNhbWVyYSA9IG5ldyBUSFJFRS5QZXJzcGVjdGl2ZUNhbWVyYSggNjAsIHdpbmRvdy5pbm5lcldpZHRoIC8gd2luZG93LmlubmVySGVpZ2h0LCAwLjIsIDIwMDAgKTtcclxuXHJcbiAgICAgICAgdGhpcy5zY2VuZSA9IG5ldyBUSFJFRS5TY2VuZSgpO1xyXG4gICAgICAgIHRoaXMuY2FtZXJhLnBvc2l0aW9uLnNldCgtMjUsIDI1LCA3OCk7XHJcbiAgICAgICAgdGhpcy5jYW1lcmEubG9va0F0KG5ldyBUSFJFRS5WZWN0b3IzKCkpO1xyXG4gICAgICAgIGNvbnNvbGUubG9nKHRoaXMuY2FtZXJhKTtcclxuXHJcbiAgICAgICAgLy8gdGhpcy5jYW52YXMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImNhbnZhc1wiKSBhcyBhbnk7XHJcbiAgICAgICAgLy8gdGhpcy5jb250cm9scyA9IG5ldyBPcmJpdENvbnRyb2xzKCB0aGlzLmNhbWVyYSwgdGhpcy5jYW52YXMgKTtcclxuICAgICAgICAvLyB0aGlzLmNvbnRyb2xzLnRhcmdldC55ID0gMjtcclxuXHJcbiAgICAgICAgdGhpcy5yZW5kZXJlciA9IG5ldyBUSFJFRS5XZWJHTFJlbmRlcmVyKHtcclxuICAgICAgICAgICAgY2FudmFzOiB0aGlzLmNhbnZhcyxcclxuICAgICAgICAgICAgYW50aWFsaWFzOiB0cnVlLFxyXG4gICAgICAgICAgICBhbHBoYTogdHJ1ZVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHRoaXMucmVuZGVyZXIuc2V0Q2xlYXJDb2xvciggMHgwMDAwMDAgKTtcclxuICAgICAgICB0aGlzLnJlbmRlcmVyLnNldFBpeGVsUmF0aW8oIHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvICk7XHJcbiAgICAgICAgdGhpcy5yZW5kZXJlci5zZXRTaXplKCB3aW5kb3cuaW5uZXJXaWR0aCwgd2luZG93LmlubmVySGVpZ2h0ICk7XHJcbiAgICAgICAgdGhpcy5yZW5kZXJlci5zaGFkb3dNYXAuZW5hYmxlZCA9IHRydWU7XHJcblxyXG4gICAgICAgIC8vIHZhciBhbWJpZW50TGlnaHQgPSBuZXcgVEhSRUUuQW1iaWVudExpZ2h0KCAweGZmZmZmZiApO1xyXG4gICAgICAgIC8vIHRoaXMuc2NlbmUuYWRkKCBhbWJpZW50TGlnaHQgKTtcclxuXHJcbiAgICAgICAgdGhpcy5maXJlID0gbmV3IEZpcmUoKTtcclxuICAgICAgICB0aGlzLnNjZW5lLmFkZCggdGhpcy5maXJlLmxpZ2h0ICk7XHJcbiAgICAgICAgLy8gdGhpcy5zY2VuZS5hZGQobmV3IFRIUkVFLkRpcmVjdGlvbmFsTGlnaHRIZWxwZXIobGlnaHQpKTtcclxuICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lciggJ3Jlc2l6ZScsIHRoaXMub25SZXNpemUsIGZhbHNlICk7XHJcbiAgICB9XHJcblxyXG4gICAgb25SZXNpemUoZTpFdmVudCk6dm9pZHtcclxuICAgICAgICB0aGlzLnNpemUgPSB0aGlzLmdldFN0YWdlU2l6ZSh0cnVlKTtcclxuICAgICAgICB0aGlzLmNhbnZhcy53aWR0aCA9IHRoaXMuc2l6ZS53aWR0aDtcclxuICAgICAgICB0aGlzLmNhbnZhcy5oZWlnaHQgPSB0aGlzLnNpemUuaGVpZ2h0O1xyXG4gICAgICAgIHRoaXMuY2FtZXJhLmFzcGVjdCA9IHRoaXMuc2l6ZS53aWR0aCAvIHRoaXMuc2l6ZS5oZWlnaHQ7XHJcbiAgICAgICAgdGhpcy5jYW1lcmEudXBkYXRlUHJvamVjdGlvbk1hdHJpeCgpO1xyXG4gICAgICAgIHRoaXMucmVuZGVyZXIuc2V0U2l6ZSh0aGlzLnNpemUud2lkdGgsIHRoaXMuc2l6ZS5oZWlnaHQpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldFN0YWdlU2l6ZSh1c2VQaXhlbD86Ym9vbGVhbik6YW55e1xyXG4gICAgICAgIHZhciBzaXplOmFueSA9IHt3aWR0aDogd2luZG93LmlubmVyV2lkdGh9O1xyXG4gICAgICAgIGlmKHdpbmRvdy5pbm5lcldpZHRoID4gd2luZG93LmlubmVySGVpZ2h0KXtcclxuICAgICAgICAgICAgc2l6ZS5oZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2V7XHJcbiAgICAgICAgICAgIHNpemUuaGVpZ2h0ID0gd2luZG93LmlubmVyV2lkdGg7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmKHVzZVBpeGVsKXtcclxuICAgICAgICAgICAgc2l6ZS53aWR0aCA9IHNpemUud2lkdGggKiB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbztcclxuICAgICAgICAgICAgc2l6ZS5oZWlnaHQgPSBzaXplLmhlaWdodCAqIHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gc2l6ZTtcclxuICAgIH1cclxuXHJcbiAgICBpbml0UGh5c2ljcygpe1xyXG4gICAgICAgIHRoaXMuYWRkU3RhdGljQm94KFs0LCA0MCwgNDBdLCBbLTEwLCAtNCwgMF0sIFswLCAwLCAwXSk7XHJcbiAgICAgICAgdGhpcy5hZGRTdGF0aWNCb3goWzQsIDQwLCA0MF0sIFsxMCwgLTQsIDBdLCBbMCwgMCwgMF0pO1xyXG4gICAgICAgIHRoaXMuYWRkU3RhdGljQm94KFs4MCwgOCwgODBdLCBbMCwgLTIsIDBdLCBbMzAsIDAsIDBdKTtcclxuXHJcbiAgICAgICAgLy8gQ29tcHV0ZUdlb21ldHJ5LmNoZWNrVGhyZWUoVEhSRUUpO1xyXG5cclxuICAgICAgICAvLyB2YXIgYm94MSA9IG5ldyBUSFJFRS5NZXNoKG5ldyBUSFJFRS5Cb3hHZW9tZXRyeSgyMCwgMSwgMjApLCBuZXcgVEhSRUUuTWVzaFN0YW5kYXJkTWF0ZXJpYWwoKSk7XHJcbiAgICAgICAgLy8gdmFyIGJveDIgPSBuZXcgVEhSRUUuTWVzaChuZXcgVEhSRUUuQm94R2VvbWV0cnkoNCwgMiwgNCksIG5ldyBUSFJFRS5NZXNoU3RhbmRhcmRNYXRlcmlhbCgpKTtcclxuXHJcbiAgICAgICAgLy8gdmFyIHJlcyA9IENvbXB1dGVHZW9tZXRyeS5zdWJ0cmFjdChib3gxLCBib3gyKTtcclxuICAgICAgICAvLyAocmVzIGFzIFRIUkVFLk1lc2gpLm1hdGVyaWFsID0gbmV3IFRIUkVFLk1lc2hTdGFuZGFyZE1hdGVyaWFsKHtjb2xvcjogMHhmZjk5MDB9KTtcclxuICAgICAgICAvLyByZXMucG9zaXRpb24ueSA9IDEwO1xyXG4gICAgICAgIC8vIHZhciBtZXNoID0gbmV3IFRIUkVFLk1lc2goZ2VvLCBuZXcgVEhSRUUuTWVzaE5vcm1hbE1hdGVyaWFsKCkpO1xyXG4gICAgICAgIC8vIHRoaXMuc2NlbmUuYWRkKHJlcyk7XHJcbiAgICB9XHJcblxyXG4gICAgYWRkU3RhdGljQm94KHNpemU6YW55LCBwb3NpdGlvbjphbnksIHJvdGF0aW9uOmFueSkge1xyXG4gICAgICAgIHRoaXMud29ybGQuYWRkKHtzaXplOiBzaXplLCBwb3M6IHBvc2l0aW9uLCByb3Q6IHJvdGF0aW9uLCBtb3ZlOiBmYWxzZX0pO1xyXG5cclxuICAgICAgICB2YXIgIFRvUmFkID0gMC4wMTc0NTMyOTI1MTk5NDMyOTU3O1xyXG4gICAgICAgIGxldCBtYXQ6IFRIUkVFLk1lc2hTdGFuZGFyZE1hdGVyaWFsID0gbmV3IFRIUkVFLk1lc2hTdGFuZGFyZE1hdGVyaWFsKCk7XHJcbiAgICAgICAgbWF0Lm1ldGFsbmVzcyA9IDAuMTtcclxuICAgICAgICBtYXQucm91Z2huZXNzID0gMC43MjtcclxuICAgICAgICBtYXQubWFwID0gbmV3IFRIUkVFLlRleHR1cmVMb2FkZXIoKS5sb2FkKFwiaW1hZ2VzL2ltZy9wNi5qcGdcIik7XHJcbiAgICAgICAgdmFyIG1lc2ggPSBuZXcgVEhSRUUuTWVzaCggbmV3IFRIUkVFLkJveEdlb21ldHJ5KCksIG1hdCApO1xyXG4gICAgICAgIG1lc2guc2NhbGUuc2V0KCBzaXplWzBdLCBzaXplWzFdLCBzaXplWzJdICk7XHJcbiAgICAgICAgbWVzaC5wb3NpdGlvbi5zZXQoIHBvc2l0aW9uWzBdLCBwb3NpdGlvblsxXSwgcG9zaXRpb25bMl0gKTtcclxuICAgICAgICBtZXNoLnJvdGF0aW9uLnNldCggcm90YXRpb25bMF0gKiBUb1JhZCwgcm90YXRpb25bMV0gKiBUb1JhZCwgcm90YXRpb25bMl0gKiBUb1JhZCApO1xyXG4gICAgICAgIHRoaXMuc2NlbmUuYWRkKCBtZXNoICk7XHJcbiAgICAgICAgLy8gZ3JvdW5kcy5wdXNoKG1lc2gpO1xyXG4gICAgICAgIG1lc2guY2FzdFNoYWRvdyA9IHRydWU7XHJcbiAgICAgICAgbWVzaC5yZWNlaXZlU2hhZG93ID0gdHJ1ZTtcclxuICAgIH1cclxuXHJcbiAgICBjcmVhdGVPYmplY3RzKCl7XHJcbiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IDEwMDA7IGkrKyl7XHJcbiAgICAgICAgICAgIGxldCB0eXBlID0gXCJzcGhlcmVcIjtcclxuICAgICAgICAgICAgaWYoaSAlIDIpe1xyXG4gICAgICAgICAgICAgICAgdHlwZSA9XCJib3hcIjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBsZXQgc2hhcGU7XHJcbiAgICAgICAgICAgIGlmKHR5cGUgPT0gXCJib3hcIil7XHJcbiAgICAgICAgICAgICAgICBzaGFwZSA9IHRoaXMuc3RvcmUuZ2V0Qm94QnVmZmVyR2VvbWV0cnkoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNle1xyXG4gICAgICAgICAgICAgICAgc2hhcGUgPSB0aGlzLnN0b3JlLmdldFNwaGVyZUJ1ZmZlckdlb21ldHJ5KCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIHZpZXcgPSBuZXcgVEhSRUUuTWVzaChzaGFwZSwgdGhpcy5zdG9yZS5nZXRNYXRlcmlhbCgpKTtcclxuICAgICAgICAgICAgbGV0IHggPSAoMC41IC0gTWF0aC5yYW5kb20oKSkgKiA0MDtcclxuICAgICAgICAgICAgbGV0IHkgPSBNYXRoLnJhbmRvbSgpICogMTYwMDtcclxuICAgICAgICAgICAgbGV0IHogPSAoMC41IC0gTWF0aC5yYW5kb20oKSkgKiA0MDtcclxuICAgICAgICAgICAgdmlldy5wb3NpdGlvbi5zZXQoeCwgeSwgeik7XHJcbiAgICAgICAgICAgIHZpZXcuY2FzdFNoYWRvdyA9IHRydWU7XHJcbiAgICAgICAgICAgIHZpZXcucmVjZWl2ZVNoYWRvdyA9IHRydWU7XHJcbiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHZpZXcpO1xyXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZXJzLnB1c2gobmV3IFBoeXNpY3NWaWV3KHZpZXcsIHR5cGUsIHRoaXMud29ybGQpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICB9XHJcblxyXG4gICAgaW5pdElucHV0KCl7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIGFuaW1hdGUoKSB7XHJcbiAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpPT57XHJcbiAgICAgICAgICAgIHRoaXMuYW5pbWF0ZSgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHRoaXMud29ybGQuc3RlcCgpO1xyXG4gICAgICAgIHRoaXMuZmlyZS51cGRhdGUoKTtcclxuICAgICAgICB0aGlzLnVwZGF0ZXJzLmZvckVhY2goKGl0ZW06UGh5c2ljc1ZpZXcpPT57XHJcbiAgICAgICAgICAgIGl0ZW0udXBkYXRlKCk7XHJcbiAgICAgICAgfSlcclxuICAgICAgICB0aGlzLnJlbmRlcigpO1xyXG4gICAgICAgIC8vIHRoaXMuc3RhdHMudXBkYXRlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcmVuZGVyKCkge1xyXG4gICAgICAgIC8vIHZhciBkZWx0YVRpbWUgPSBjbG9jay5nZXREZWx0YSgpO1xyXG4gICAgICAgIC8vIHVwZGF0ZVBoeXNpY3MoIGRlbHRhVGltZSApO1xyXG4gICAgICAgIC8vIHByb2Nlc3NDbGljaygpO1xyXG4gICAgICAgIC8vIGNvbnRyb2xzLnVwZGF0ZSggZGVsdGFUaW1lICk7XHJcbiAgICAgICAgdGhpcy5yZW5kZXJlci5yZW5kZXIoIHRoaXMuc2NlbmUsIHRoaXMuY2FtZXJhICk7XHJcblxyXG4gICAgfVxyXG5cclxufSJdfQ==