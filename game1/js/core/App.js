"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var THREE = require("three");
var PhysicsView_1 = require("./PhysicsView");
var Store_1 = require("./Store");
var Fire_1 = require("./Fire");
var OIMO = require('oimo');
console.log("oimo");
console.log(OIMO);
var App = (function () {
    function App(canvas) {
        this.updaters = [];
        this.store = new Store_1.default();
        this.canvas = canvas;
        this.world = new OIMO.World({
            timestep: 1 / 60,
            iterations: 8,
            broadphase: 2,
            worldscale: 1,
            random: true,
            info: false,
            gravity: [0, -9.8, 0]
        });
        this.initGraphics();
        this.initPhysics();
        this.createObjects();
        this.animate();
    }
    App.prototype.initGraphics = function () {
        this.camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.2, 2000);
        this.scene = new THREE.Scene();
        this.camera.position.set(-25, 25, 78);
        this.camera.lookAt(new THREE.Vector3());
        console.log(this.camera);
        this.renderer = new THREE.WebGLRenderer({
            canvas: this.canvas,
            antialias: true,
            alpha: true
        });
        this.renderer.setClearColor(0x000000);
        this.renderer.setPixelRatio(window.devicePixelRatio);
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        this.renderer.shadowMap.enabled = true;
        this.fire = new Fire_1.default();
        this.scene.add(this.fire.light);
        window.addEventListener('resize', this.onResize, false);
    };
    App.prototype.onResize = function (e) {
        this.size = this.getStageSize(true);
        this.canvas.width = this.size.width;
        this.canvas.height = this.size.height;
        this.camera.aspect = this.size.width / this.size.height;
        this.camera.updateProjectionMatrix();
        this.renderer.setSize(this.size.width, this.size.height);
    };
    App.prototype.getStageSize = function (usePixel) {
        var size = { width: window.innerWidth };
        if (window.innerWidth > window.innerHeight) {
            size.height = window.innerHeight;
        }
        else {
            size.height = window.innerWidth;
        }
        if (usePixel) {
            size.width = size.width * window.devicePixelRatio;
            size.height = size.height * window.devicePixelRatio;
        }
        return size;
    };
    App.prototype.initPhysics = function () {
        this.addStaticBox([4, 40, 40], [-10, -4, 0], [0, 0, 0]);
        this.addStaticBox([4, 40, 40], [10, -4, 0], [0, 0, 0]);
        this.addStaticBox([80, 8, 80], [0, -2, 0], [30, 0, 0]);
    };
    App.prototype.addStaticBox = function (size, position, rotation) {
        this.world.add({ size: size, pos: position, rot: rotation, move: false });
        var ToRad = 0.0174532925199432957;
        var mat = new THREE.MeshNormalMaterial();
        var mesh = new THREE.Mesh(new THREE.BoxGeometry(), mat);
        mesh.scale.set(size[0], size[1], size[2]);
        mesh.position.set(position[0], position[1], position[2]);
        mesh.rotation.set(rotation[0] * ToRad, rotation[1] * ToRad, rotation[2] * ToRad);
        this.scene.add(mesh);
        mesh.castShadow = true;
        mesh.receiveShadow = true;
    };
    App.prototype.createObjects = function () {
        for (var i = 0; i < 1000; i++) {
            var type = "sphere";
            if (i % 2) {
                type = "box";
            }
            var shape = void 0;
            if (type == "box") {
                shape = this.store.getBoxBufferGeometry();
            }
            else {
                shape = this.store.getSphereBufferGeometry();
            }
            var view = new THREE.Mesh(shape, this.store.getMaterial());
            var x = (0.5 - Math.random()) * 40;
            var y = Math.random() * 1600;
            var z = (0.5 - Math.random()) * 40;
            view.position.set(x, y, z);
            view.castShadow = true;
            view.receiveShadow = true;
            this.scene.add(view);
            this.updaters.push(new PhysicsView_1.default(view, type, this.world));
        }
    };
    App.prototype.initInput = function () {
    };
    App.prototype.animate = function () {
        var _this = this;
        requestAnimationFrame(function () {
            _this.animate();
        });
        this.world.step();
        this.fire.update();
        this.updaters.forEach(function (item) {
            item.update();
        });
        this.render();
    };
    App.prototype.render = function () {
        this.renderer.render(this.scene, this.camera);
    };
    return App;
}());
exports.default = App;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXBwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiQXBwLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0EsNkJBQThCO0FBRTlCLDZDQUF3QztBQUN4QyxpQ0FBNEI7QUFDNUIsK0JBQTBCO0FBSTFCLElBQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQTtBQUU1QixPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQ3BCLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7QUFFbEI7SUFpQkksYUFBWSxNQUFVO1FBSnRCLGFBQVEsR0FBdUIsRUFBRSxDQUFDO1FBQ2xDLFVBQUssR0FBUyxJQUFJLGVBQUssRUFBRSxDQUFDO1FBSXRCLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDO1lBQ3hCLFFBQVEsRUFBRSxDQUFDLEdBQUcsRUFBRTtZQUNoQixVQUFVLEVBQUUsQ0FBQztZQUNiLFVBQVUsRUFBRSxDQUFDO1lBQ2IsVUFBVSxFQUFFLENBQUM7WUFDYixNQUFNLEVBQUUsSUFBSTtZQUNaLElBQUksRUFBRSxLQUFLO1lBQ1gsT0FBTyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztTQUN4QixDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDcEIsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ25CLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUNyQixJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDbkIsQ0FBQztJQUVELDBCQUFZLEdBQVo7UUFDSSxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksS0FBSyxDQUFDLGlCQUFpQixDQUFFLEVBQUUsRUFBRSxNQUFNLENBQUMsVUFBVSxHQUFHLE1BQU0sQ0FBQyxXQUFXLEVBQUUsR0FB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QUNJLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDeEQsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdkQsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFZM0QsQ0FBQztJQUVELDBCQUFZLEdBQVosVUFBYSxJQUFRLEVBQUUsUUFBWSxFQUFFLFFBQVk7UUFDN0MsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxRQUFRLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFDLENBQUMsQ0FBQztRQUV4RSxJQUFLLEtBQUssR0FBRyxxQkFBcUIsQ0FBQztRQU9uQyxJQUFJLEdBQUcsR0FBNkIsSUFBSSxLQUFLLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztRQUVuRSxJQUFJLElBQUksR0FBRyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUUsSUFBSSxLQUFLLENBQUMsV0FBVyxFQUFFLEVBQUUsR0FBRyxDQUFFLENBQUM7UUFDMUQsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLElB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LENBQUMsTUFBTSxDQUFFLElBQUksQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBRSxDQUFDO0lBRXBELENBQUM7SUFFTCxVQUFDO0FBQUQsQ0FBQyxBQXJMRCxJQXFMQyIsInNvdXJjZXNDb250ZW50IjpbIlxyXG5pbXBvcnQgKiBhcyBUSFJFRSBmcm9tICd0aHJlZSdcclxuLy8gaW1wb3J0IHsgT3JiaXRDb250cm9scyB9IGZyb20gJ3RocmVlL2V4YW1wbGVzL2pzbS9jb250cm9scy9PcmJpdENvbnRyb2xzJztcclxuaW1wb3J0IFBoeXNpY3NWaWV3IGZyb20gJy4vUGh5c2ljc1ZpZXcnO1xyXG5pbXBvcnQgU3RvcmUgZnJvbSAnLi9TdG9yZSc7XHJcbmltcG9ydCBGaXJlIGZyb20gJy4vRmlyZSc7XHJcbi8vIGltcG9ydCBDb21wdXRlR2VvbWV0cnkgZnJvbSAnLi9Db21wdXRlR2VvbWV0cnknO1xyXG5cclxuLy8gaW1wb3J0ICogYXMgQW1tbyBmcm9tICcuLi9hc3NldC9saWIvYW1tbydcclxuY29uc3QgT0lNTyA9IHJlcXVpcmUoJ29pbW8nKVxyXG5cclxuY29uc29sZS5sb2coXCJvaW1vXCIpO1xyXG5jb25zb2xlLmxvZyhPSU1PKTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEFwcHtcclxuXHJcbiAgICAvLyBjb250cm9sczpPcmJpdENvbnRyb2xzO1xyXG4gICAgY2FtZXJhOiBUSFJFRS5QZXJzcGVjdGl2ZUNhbWVyYTtcclxuICAgIHNjZW5lOiBUSFJFRS5TY2VuZTtcclxuICAgIHJlbmRlcmVyOiBUSFJFRS5XZWJHTFJlbmRlcmVyO1xyXG4gICAgc2l6ZTphbnk7XHJcbiAgICBjYW52YXM6IGFueTtcclxuICAgIHN0YXRzOiBhbnk7XHJcbiAgICBjbG9jazogVEhSRUUuQ2xvY2s7XHJcblxyXG4gICAgcGh5c2ljc1dvcmxkOmFueTtcclxuICAgIHdvcmxkOmFueTtcclxuICAgIHVwZGF0ZXJzOiBBcnJheTxQaHlzaWNzVmlldz4gPSBbXTtcclxuICAgIHN0b3JlOlN0b3JlID0gbmV3IFN0b3JlKCk7XHJcbiAgICBmaXJlOkZpcmU7XHJcblxyXG4gICAgY29uc3RydWN0b3IoY2FudmFzOmFueSl7XHJcbiAgICAgICAgdGhpcy5jYW52YXMgPSBjYW52YXM7XHJcbiAgICAgICAgdGhpcy53b3JsZCA9IG5ldyBPSU1PLldvcmxkKHsgXHJcbiAgICAgICAgICAgIHRpbWVzdGVwOiAxIC8gNjAsIFxyXG4gICAgICAgICAgICBpdGVyYXRpb25zOiA4LCBcclxuICAgICAgICAgICAgYnJvYWRwaGFzZTogMiwgLy8gMSBicnV0ZSBmb3JjZSwgMiBzd2VlcCBhbmQgcHJ1bmUsIDMgdm9sdW1lIHRyZWVcclxuICAgICAgICAgICAgd29ybGRzY2FsZTogMSwgLy8gc2NhbGUgZnVsbCB3b3JsZCBcclxuICAgICAgICAgICAgcmFuZG9tOiB0cnVlLCAgLy8gcmFuZG9taXplIHNhbXBsZVxyXG4gICAgICAgICAgICBpbmZvOiBmYWxzZSwgICAvLyBjYWxjdWxhdGUgc3RhdGlzdGljIG9yIG5vdFxyXG4gICAgICAgICAgICBncmF2aXR5OiBbMCwgLTkuOCwgMF0gXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMuaW5pdEdyYXBoaWNzKCk7XHJcbiAgICAgICAgdGhpcy5pbml0UGh5c2ljcygpO1xyXG4gICAgICAgIHRoaXMuY3JlYXRlT2JqZWN0cygpO1xyXG4gICAgICAgIHRoaXMuYW5pbWF0ZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIGluaXRHcmFwaGljcygpe1xyXG4gICAgICAgIHRoaXMuY2FtZXJhID0gbmV3IFRIUkVFLlBlcnNwZWN0aXZlQ2FtZXJhKCA2MCwgd2luZG93LmlubmVyV2lkdGggLyB3aW5kb3cuaW5uZXJIZWlnaHQsIDAuMiwgMjAwMCApO1xyXG5cclxuICAgICAgICB0aGlzLnNjZW5lID0gbmV3IFRIUkVFLlNjZW5lKCk7XHJcbiAgICAgICAgdGhpcy5jYW1lcmEucG9zaXRpb24uc2V0KC0yNSwgMjUsIDc4KTtcclxuICAgICAgICB0aGlzLmNhbWVyYS5sb29rQXQobmV3IFRIUkVFLlZlY3RvcjMoKSk7XHJcbiAgICAgICAgY29uc29sZS5sb2codGhpcy5jYW1lcmEpO1xyXG5cclxuICAgICAgICAvLyB0aGlzLmNhbnZhcyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiY2FudmFzXCIpIGFzIGFueTtcclxuICAgICAgICAvLyB0aGlzLmNvbnRyb2xzID0gbmV3IE9yYml0Q29udHJvbHMoIHRoaXMuY2FtZXJhLCB0aGlzLmNhbnZhcyApO1xyXG4gICAgICAgIC8vIHRoaXMuY29udHJvbHMudGFyZ2V0LnkgPSAyO1xyXG5cclxuICAgICAgICB0aGlzLnJlbmRlcmVyID0gbmV3IFRIUkVFLldlYkdMUmVuZGVyZXIoe1xyXG4gICAgICAgICAgICBjYW52YXM6IHRoaXMuY2FudmFzLFxyXG4gICAgICAgICAgICBhbnRpYWxpYXM6IHRydWUsXHJcbiAgICAgICAgICAgIGFscGhhOiB0cnVlXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5yZW5kZXJlci5zZXRDbGVhckNvbG9yKCAweDAwMDAwMCApO1xyXG4gICAgICAgIHRoaXMucmVuZGVyZXIuc2V0UGl4ZWxSYXRpbyggd2luZG93LmRldmljZVBpeGVsUmF0aW8gKTtcclxuICAgICAgICB0aGlzLnJlbmRlcmVyLnNldFNpemUoIHdpbmRvdy5pbm5lcldpZHRoLCB3aW5kb3cuaW5uZXJIZWlnaHQgKTtcclxuICAgICAgICB0aGlzLnJlbmRlcmVyLnNoYWRvd01hcC5lbmFibGVkID0gdHJ1ZTtcclxuXHJcbiAgICAgICAgLy8gdmFyIGFtYmllbnRMaWdodCA9IG5ldyBUSFJFRS5BbWJpZW50TGlnaHQoIDB4ZmZmZmZmICk7XHJcbiAgICAgICAgLy8gdGhpcy5zY2VuZS5hZGQoIGFtYmllbnRMaWdodCApO1xyXG5cclxuICAgICAgICB0aGlzLmZpcmUgPSBuZXcgRmlyZSgpO1xyXG4gICAgICAgIHRoaXMuc2NlbmUuYWRkKCB0aGlzLmZpcmUubGlnaHQgKTtcclxuICAgICAgICAvLyB0aGlzLnNjZW5lLmFkZChuZXcgVEhSRUUuRGlyZWN0aW9uYWxMaWdodEhlbHBlcihsaWdodCkpO1xyXG4gICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCAncmVzaXplJywgdGhpcy5vblJlc2l6ZSwgZmFsc2UgKTtcclxuICAgIH1cclxuXHJcbiAgICBvblJlc2l6ZShlOkV2ZW50KTp2b2lke1xyXG4gICAgICAgIHRoaXMuc2l6ZSA9IHRoaXMuZ2V0U3RhZ2VTaXplKHRydWUpO1xyXG4gICAgICAgIHRoaXMuY2FudmFzLndpZHRoID0gdGhpcy5zaXplLndpZHRoO1xyXG4gICAgICAgIHRoaXMuY2FudmFzLmhlaWdodCA9IHRoaXMuc2l6ZS5oZWlnaHQ7XHJcbiAgICAgICAgdGhpcy5jYW1lcmEuYXNwZWN0ID0gdGhpcy5zaXplLndpZHRoIC8gdGhpcy5zaXplLmhlaWdodDtcclxuICAgICAgICB0aGlzLmNhbWVyYS51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCk7XHJcbiAgICAgICAgdGhpcy5yZW5kZXJlci5zZXRTaXplKHRoaXMuc2l6ZS53aWR0aCwgdGhpcy5zaXplLmhlaWdodCk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0U3RhZ2VTaXplKHVzZVBpeGVsPzpib29sZWFuKTphbnl7XHJcbiAgICAgICAgdmFyIHNpemU6YW55ID0ge3dpZHRoOiB3aW5kb3cuaW5uZXJXaWR0aH07XHJcbiAgICAgICAgaWYod2luZG93LmlubmVyV2lkdGggPiB3aW5kb3cuaW5uZXJIZWlnaHQpe1xyXG4gICAgICAgICAgICBzaXplLmhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodDtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZXtcclxuICAgICAgICAgICAgc2l6ZS5oZWlnaHQgPSB3aW5kb3cuaW5uZXJXaWR0aDtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYodXNlUGl4ZWwpe1xyXG4gICAgICAgICAgICBzaXplLndpZHRoID0gc2l6ZS53aWR0aCAqIHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvO1xyXG4gICAgICAgICAgICBzaXplLmhlaWdodCA9IHNpemUuaGVpZ2h0ICogd2luZG93LmRldmljZVBpeGVsUmF0aW87XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBzaXplO1xyXG4gICAgfVxyXG5cclxuICAgIGluaXRQaHlzaWNzKCl7XHJcbiAgICAgICAgdGhpcy5hZGRTdGF0aWNCb3goWzQsIDQwLCA0MF0sIFstMTAsIC00LCAwXSwgWzAsIDAsIDBdKTtcclxuICAgICAgICB0aGlzLmFkZFN0YXRpY0JveChbNCwgNDAsIDQwXSwgWzEwLCAtNCwgMF0sIFswLCAwLCAwXSk7XHJcbiAgICAgICAgdGhpcy5hZGRTdGF0aWNCb3goWzgwLCA4LCA4MF0sIFswLCAtMiwgMF0sIFszMCwgMCwgMF0pO1xyXG5cclxuICAgICAgICAvLyBDb21wdXRlR2VvbWV0cnkuY2hlY2tUaHJlZShUSFJFRSk7XHJcblxyXG4gICAgICAgIC8vIHZhciBib3gxID0gbmV3IFRIUkVFLk1lc2gobmV3IFRIUkVFLkJveEdlb21ldHJ5KDIwLCAxLCAyMCksIG5ldyBUSFJFRS5NZXNoU3RhbmRhcmRNYXRlcmlhbCgpKTtcclxuICAgICAgICAvLyB2YXIgYm94MiA9IG5ldyBUSFJFRS5NZXNoKG5ldyBUSFJFRS5Cb3hHZW9tZXRyeSg0LCAyLCA0KSwgbmV3IFRIUkVFLk1lc2hTdGFuZGFyZE1hdGVyaWFsKCkpO1xyXG5cclxuICAgICAgICAvLyB2YXIgcmVzID0gQ29tcHV0ZUdlb21ldHJ5LnN1YnRyYWN0KGJveDEsIGJveDIpO1xyXG4gICAgICAgIC8vIChyZXMgYXMgVEhSRUUuTWVzaCkubWF0ZXJpYWwgPSBuZXcgVEhSRUUuTWVzaFN0YW5kYXJkTWF0ZXJpYWwoe2NvbG9yOiAweGZmOTkwMH0pO1xyXG4gICAgICAgIC8vIHJlcy5wb3NpdGlvbi55ID0gMTA7XHJcbiAgICAgICAgLy8gdmFyIG1lc2ggPSBuZXcgVEhSRUUuTWVzaChnZW8sIG5ldyBUSFJFRS5NZXNoTm9ybWFsTWF0ZXJpYWwoKSk7XHJcbiAgICAgICAgLy8gdGhpcy5zY2VuZS5hZGQocmVzKTtcclxuICAgIH1cclxuXHJcbiAgICBhZGRTdGF0aWNCb3goc2l6ZTphbnksIHBvc2l0aW9uOmFueSwgcm90YXRpb246YW55KSB7XHJcbiAgICAgICAgdGhpcy53b3JsZC5hZGQoe3NpemU6IHNpemUsIHBvczogcG9zaXRpb24sIHJvdDogcm90YXRpb24sIG1vdmU6IGZhbHNlfSk7XHJcblxyXG4gICAgICAgIHZhciAgVG9SYWQgPSAwLjAxNzQ1MzI5MjUxOTk0MzI5NTc7XHJcblxyXG4gICAgICAgIC8vIGxldCBtYXQ6IFRIUkVFLk1lc2hTdGFuZGFyZE1hdGVyaWFsID0gbmV3IFRIUkVFLk1lc2hTdGFuZGFyZE1hdGVyaWFsKCk7XHJcbiAgICAgICAgLy8gbWF0Lm1ldGFsbmVzcyA9IDAuMTtcclxuICAgICAgICAvLyBtYXQucm91Z2huZXNzID0gMC43MjtcclxuICAgICAgICAvLyBtYXQubWFwID0gbmV3IFRIUkVFLlRleHR1cmVMb2FkZXIoKS5sb2FkKFwiaW1hZ2VzL2ltZy9wNi5qcGdcIik7XHJcblxyXG4gICAgICAgIGxldCBtYXQ6IFRIUkVFLk1lc2hOb3JtYWxNYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoTm9ybWFsTWF0ZXJpYWwoKTtcclxuXHJcbiAgICAgICAgdmFyIG1lc2ggPSBuZXcgVEhSRUUuTWVzaCggbmV3IFRIUkVFLkJveEdlb21ldHJ5KCksIG1hdCApO1xyXG4gICAgICAgIG1lc2guc2NhbGUuc2V0KCBzaXplWzBdLCBzaXplWzFdLCBzaXplWzJdICk7XHJcbiAgICAgICAgbWVzaC5wb3NpdGlvbi5zZXQoIHBvc2l0aW9uWzBdLCBwb3NpdGlvblsxXSwgcG9zaXRpb25bMl0gKTtcclxuICAgICAgICBtZXNoLnJvdGF0aW9uLnNldCggcm90YXRpb25bMF0gKiBUb1JhZCwgcm90YXRpb25bMV0gKiBUb1JhZCwgcm90YXRpb25bMl0gKiBUb1JhZCApO1xyXG4gICAgICAgIHRoaXMuc2NlbmUuYWRkKCBtZXNoICk7XHJcbiAgICAgICAgLy8gZ3JvdW5kcy5wdXNoKG1lc2gpO1xyXG4gICAgICAgIG1lc2guY2FzdFNoYWRvdyA9IHRydWU7XHJcbiAgICAgICAgbWVzaC5yZWNlaXZlU2hhZG93ID0gdHJ1ZTtcclxuICAgIH1cclxuXHJcbiAgICBjcmVhdGVPYmplY3RzKCl7XHJcbiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IDEwMDA7IGkrKyl7XHJcbiAgICAgICAgICAgIGxldCB0eXBlID0gXCJzcGhlcmVcIjtcclxuICAgICAgICAgICAgaWYoaSAlIDIpe1xyXG4gICAgICAgICAgICAgICAgdHlwZSA9XCJib3hcIjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBsZXQgc2hhcGU7XHJcbiAgICAgICAgICAgIGlmKHR5cGUgPT0gXCJib3hcIil7XHJcbiAgICAgICAgICAgICAgICBzaGFwZSA9IHRoaXMuc3RvcmUuZ2V0Qm94QnVmZmVyR2VvbWV0cnkoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNle1xyXG4gICAgICAgICAgICAgICAgc2hhcGUgPSB0aGlzLnN0b3JlLmdldFNwaGVyZUJ1ZmZlckdlb21ldHJ5KCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIHZpZXcgPSBuZXcgVEhSRUUuTWVzaChzaGFwZSwgdGhpcy5zdG9yZS5nZXRNYXRlcmlhbCgpKTtcclxuICAgICAgICAgICAgbGV0IHggPSAoMC41IC0gTWF0aC5yYW5kb20oKSkgKiA0MDtcclxuICAgICAgICAgICAgbGV0IHkgPSBNYXRoLnJhbmRvbSgpICogMTYwMDtcclxuICAgICAgICAgICAgbGV0IHogPSAoMC41IC0gTWF0aC5yYW5kb20oKSkgKiA0MDtcclxuICAgICAgICAgICAgdmlldy5wb3NpdGlvbi5zZXQoeCwgeSwgeik7XHJcbiAgICAgICAgICAgIHZpZXcuY2FzdFNoYWRvdyA9IHRydWU7XHJcbiAgICAgICAgICAgIHZpZXcucmVjZWl2ZVNoYWRvdyA9IHRydWU7XHJcbiAgICAgICAgICAgIHRoaXMuc2NlbmUuYWRkKHZpZXcpO1xyXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZXJzLnB1c2gobmV3IFBoeXNpY3NWaWV3KHZpZXcsIHR5cGUsIHRoaXMud29ybGQpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICB9XHJcblxyXG4gICAgaW5pdElucHV0KCl7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIGFuaW1hdGUoKSB7XHJcbiAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpPT57XHJcbiAgICAgICAgICAgIHRoaXMuYW5pbWF0ZSgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHRoaXMud29ybGQuc3RlcCgpO1xyXG4gICAgICAgIHRoaXMuZmlyZS51cGRhdGUoKTtcclxuICAgICAgICB0aGlzLnVwZGF0ZXJzLmZvckVhY2goKGl0ZW06UGh5c2ljc1ZpZXcpPT57XHJcbiAgICAgICAgICAgIGl0ZW0udXBkYXRlKCk7XHJcbiAgICAgICAgfSlcclxuICAgICAgICB0aGlzLnJlbmRlcigpO1xyXG4gICAgICAgIC8vIHRoaXMuc3RhdHMudXBkYXRlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcmVuZGVyKCkge1xyXG4gICAgICAgIC8vIHZhciBkZWx0YVRpbWUgPSBjbG9jay5nZXREZWx0YSgpO1xyXG4gICAgICAgIC8vIHVwZGF0ZVBoeXNpY3MoIGRlbHRhVGltZSApO1xyXG4gICAgICAgIC8vIHByb2Nlc3NDbGljaygpO1xyXG4gICAgICAgIC8vIGNvbnRyb2xzLnVwZGF0ZSggZGVsdGFUaW1lICk7XHJcbiAgICAgICAgdGhpcy5yZW5kZXJlci5yZW5kZXIoIHRoaXMuc2NlbmUsIHRoaXMuY2FtZXJhICk7XHJcblxyXG4gICAgfVxyXG5cclxufSJdfQ==